<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Adherents selon distance à la 20eme C</title>
    <script src="./javascripts/hull.js"></script>
    <script src="./javascripts/dataGeo.js"></script>
    <script src="./javascripts/fonctions.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@5/turf.min.js"></script>
    <script src="./javascripts/qpv_qva.json"></script>
	  
	
</head>
<body>
    <header>
      <h3>Adhérents de la 20ème Chaise - Saisons 2018-19 et 2019-2020 </h3>
        <a href="https://www.la20emechaise.org/" class="button">Site internet du centre social</a>
      </div>
    </header>

	<script>
	function Separateur_Milliers(value) {
    	return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
	};
	</script>
	
    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
<p> - extraction de 902 adresses de Noe <br>
    - récupération des coordonnées des adresses via https://adresse.data.gouv.fr/csv <br>
    - on va étudier :  <br>
	- Partie 1 : la localisation des adresses par rapport aux quartiers prioritaires de la ville,  <br>
	aux quartiers de veille active et aux anciens quartiers de veille;  <br>
	- Partie 2 : la répartition des adresses selon le temps de trajet à la 20ème Chaise.
</p>
		
<!-- Exemple 1 -->
<h3><a name="ex1" class="anchor" ><span class="octicon octicon-link"></span>QPV, QVA et AQV</a></h3>

<p> - récupération des polygones définissant les quartiers prioritaires via une source de type GeoJSON
    - recherche des adresses relevant d'un quartier prioritaire via fonction turf.js PointsWithinPolygon
</p>

<p>
  <div id="map_1" style="width: 840px; height: 560px"></div>
  <script>
 function exemple1() {
    var map_1 = L.map('map_1').setView([48.864891,2.389828], 15);
    var tableau_sortie = data;
  
    tableau_sortie.map( adresse => {
    let properties = {
   "lng": adresse.lng,
   "lat": adresse.lat
    };
    return properties;
    });
	 
    var PS = tableau_sortie;
   
    //var Res_Max = Math.max.apply(null,data.map(function(o){return o.duree_pied;}));
    //var Res_Min = Math.min.apply(null,data.map(function(o){return o.duree_pied;}));
  
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map_1);
 
    var layer_adresses = L.layerGroup().addTo(map_1);
    PS.forEach(
    function(latlng) {
        layer_adresses.addLayer(L.circleMarker(latlng, {radius: 2, color : 'blue'}).addTo(map_1));
	
    });
    var markers_adresses = {'markers': layer_adresses};
    L.control.layers(null, markers_adresses).addTo(map_1);
   
  var geojsonLayer = L.geoJson(geojsonFeature, { style: function(feature) {
        switch (feature.properties.c_nat_qpv) {
		case 'NQPV': return {color: "black","weight": 2.0, "opacity" : 0.7, "fillopacity" : 0.7};
            default:   return {color: "yellow","weight": 2.0, "opacity" : 0.7, "fillopacity" : 0.7};
	}
        }
	}
);
  geojsonLayer.addTo(map_1);
	 

geojsonLayer.eachLayer(function (layer) {
// layer.bindPopup('<h1>'+feature.properties.f1+'</h1><p>name: '+feature.properties.f2+'</p>')
    layer.bindPopup('<h3>'+layer.feature.properties.c_nat_qpv + ' : ' + layer.feature.properties.l_nqpv + '</h3>');
layer.on('mouseover', function (e) {
            this.openPopup();
        });
        layer.on('mouseout', function (e) {
            this.closePopup();
        });
  }); 

var points_turf = [];
layer_adresses.eachLayer(function(element)
{
var lnglat = [element._latlng.lng, element._latlng.lat];
points_turf.push(lnglat);
}
)

var inside = 
turf.pointsWithinPolygon(
 turf.points(points_turf), 
 geojsonLayer.toGeoJSON()
  );
console.log('Found ' + inside.features.length + ' features');  
//console.log("results "+JSON.stringify(inside));

for (let i=0 ; i < inside.features.length; i++)
{
var coords = [];
coords[0] = inside.features[i].geometry.coordinates[1];
coords[1] = inside.features[i].geometry.coordinates[0];	
layer_adresses.addLayer(L.circleMarker(coords, {radius: 2, color : 'red'}).addTo(map_1));
};

 document.getElementById("comment_1").innerHTML = inside.features.length +
	 ' adresses relèvent d\' un quartier prioritaire.' + layer_adresses.length - inside.features.length ' n\' en relèvent pas.'

  }
  </script>
</p>
<!-- FIN: Exemple 1 -->

<!-- Exemple 2 -->
<h3><a name="ex2" class="anchor" ><span class="octicon octicon-link"></span>Temps de trajet à pied</a></h3>

<p> - récupération des temps de trajet et distance (à pied, en voiture, en transports en commun) <br>
    à la 20ème Chaise par Google Map API <br>
    - détermination des enveloppes convexes(-concaves) par algorithme externe
</p>
	      
	      
<p>
  <div id="map_2" style="width: 840px; height: 560px"></div>
  <script>
 function exemple2() {
    var map_2 = L.map('map_2').setView([48.864891,2.389828], 15);
	 
    var bornes = [0,5,10,15,30,10000];
    var key = 'duree_pieds';

    filtrage_num(data,key);

    decoupe(filtre_num,'duree_pieds', bornes);
    
    tableau_sortie.forEach(function(element){
    element.map( adresse => {
    let properties = {
   "lng": adresse.lng,
   "lat": adresse.lat
    };
    return properties;
    });
    });
    
	 
    var PS = tableau_sortie;
   
    //var Res_Max = Math.max.apply(null,data.map(function(o){return o.duree_pied;}));
    //var Res_Min = Math.min.apply(null,data.map(function(o){return o.duree_pied;}));
  
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map_2);
    
    var points = new Array();
    var poly = new Array();
    var surface = new Array();
    var color = ['blue','green','yellow','orange','red'];
    var color_fr = ['bleue','verte','jaune','orange','rouge',];
    var convexite = [1.000,1.000,1.000,1.000,1.000];
	 
    PS.forEach(function(element){
    element.forEach(function(latlng) {
        L.circleMarker(latlng, {radius: 2, color : color[PS.indexOf(element)]}).addTo(map_2);
    });
    points[points.length]= hull(element, convexite[points.length], ['.lng', '.lat']);
    
    var points_poly = [];
    
    for (let i = 0; i < points.length; i++) {
    points_poly[i] = points[i];
    };
      
    poly[poly.length] = L.polygon(points_poly, {weight: 2, color : color[poly.length], fillopacity : 0.9}).addTo(map_2);
    surface[surface.length] = L.GeometryUtil.geodesicArea(poly[surface.length].getLatLngs()[0]);
    });
	 
    color_fr.forEach(function(element){
    document.getElementById("surf").innerHTML = document.getElementById("surf").innerHTML + ' La surface ' + color_fr[color_fr.indexOf(element)] + ' a une superficie de ' +
	    Separateur_Milliers(Math.round(surface[color_fr.indexOf(element)])) +' mètres carrés' + ' et contient ' + PS[color_fr.indexOf(element)].length + ' adresses.';
    });
   
	 
  }
  </script>
</p>
<!-- FIN: Exemple 2 -->
	      
   </section>
      </div>
    </div>
  
    <script>
    window.onload = function() {
        exemple1();}
</script>    
   <p id="comment_1"></p> 
    <script>
   window.onload = function() {	   
	exemple2();
    }
 </script>
<p id="surf"></p>

  <footer>
      <div class="inner">
       &copy; janvier 2021 <a href="mailto:francois.rigot.fr@gmail.com" target="_blank">François R</a>
      </div>
    </footer>

  </body>
</html>

